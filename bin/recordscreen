#!/bin/bash

function select-microphone {
  if pactl list sources | grep "Samson_GoMic" > /dev/null
  then echo "alsa_input.usb-Samson_Technologies_Samson_GoMic-00.analog-stereo"
  else echo "alsa_input.pci-0000_00_1f.3.analog-stereo"
  fi
}

declare output=${1:-${XRANDR_INTERNAL}}
declare outdir="$HOME/Videos/screenrecordings"

if [[ ! -d $outdir ]]
then mkdir "$outdir"
fi

declare outfile="${outdir}/$(date +"%Y-%m-%d-%H-%m-%S")-${output}.mkv"

xrandr \
  | sed -n -e "/$output/"'!d' \
           -e 's/[a-zA-Z0-9]* .* \([0-9]*\)x\([0-9]*\)+\([0-9]*\)+\([0-9]*\).*/\1 \2 \3 \4/p' \
  | {
    read width height xpos ypos
    ffmpeg \
      -f x11grab \
      -s ${width}x${height} \
      -r 30 \
      -i :0.0+${xpos},${ypos} \
      -f pulse \
      -i $(select-microphone) \
      "$outfile"
}

echo
echo "Saved to: $outfile"
