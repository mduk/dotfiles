#!/bin/bash

set -eu
shopt -s nullglob

for album
do
  pushd "$album"

  mkdir -p flac

  for flac in *.flac
  do mv "$flac" flac/
  done

  mkdir -p mp3
  for flac in flac/*.flac
  do
    mp3="mp3/$(basename "${flac%.flac}").mp3"

    if [[ ! -f "$mp3" ]]
    then
      ffmpeg -i "$flac" \
        -ab 320k \
        -map_metadata 0 \
        -id3v2_version 3 \
        "$mp3"
    fi
  done

  popd
done
