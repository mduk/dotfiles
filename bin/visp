#!/bin/bash

infile="$1"; shift

infiledir="$(dirname $infile)"
infilename="$(basename $infile)"

markers="$@"

duration=$(ffprobe "$infile" 2>&1 | grep "Duration" | awk '{print $2}' | sed 's/\(..:..:..\)...,/\1/')
markers+=" $duration"

starttime="00:00:00"

for marker in $markers
do
  endtime="$marker"

  # this won't like filenames with spaces
  outfilename=$(echo $infilename | sed "s/\./-$starttime-$endtime./")

  echo -n "$starttime-$endtime : "
  [ -f "$outfilename" ] && echo "Already exists. Skipping..."

  if [ ! -f "$outfilename" ]
  then
    echo "Writing $outfilename"
    ffmpeg -v error -y -i $infile \
      -vcodec copy -acodec copy -ss $starttime.0000 -to $endtime.0000 -sn "$outfilename"
  fi

  starttime="$marker"
done
